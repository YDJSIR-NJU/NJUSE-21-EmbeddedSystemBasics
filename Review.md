# 嵌入式复习总结

## 概念

### 定义

嵌入式系统是“用于==控制==、==监视==或者==辅助操作机器和设备==的装置” 。

国内普遍被认同的定义：

- 嵌入式系统是“以应用为中心，以计算机技术为基础，软硬件可裁减，适用于应用系统对功能、可靠性、成本、体积、功耗有严格要求的专用计算机系统”。 

- 嵌入式系统就是一个具有特定功能或用途的隐藏在某种设备中的计算机软硬件 集合体，没有固定的特征形状。

三要素：

- 嵌入：对象环境要求
- 专用：专用性，按对象要求，设计、裁剪
- 计算机：实现对象的智能化

### 特点

- 嵌入式系统通常是==形式多样、面向特定应用==的；
- 嵌入式系统得到==多种类型==的==处理器==和==处理器体系结构==的支持；
- 嵌入式系统通常极其关注成本；
- 嵌入式系统有实时性和可靠性的要求；
- 嵌入式系统开发需要专门工具和特殊方法；

嵌入式系统使用的操作系统一般是==适应多种处理器、可剪裁、轻量型、实时可靠、 可固化==的嵌入式操作系统。

### 分类

#### 按嵌入式处理器的位数来分类 

- 4位嵌入式系统
- 8位嵌入式系统
- 16位嵌入式系统
- 32位嵌入式系统
- 64位嵌入式系统 

#### 按应用来分类

- 智能家电
- 移动终端
- 工业控制
- 汽车电子
- 通信类

#### 按速度分类

- ==强实时系统==， 其系统响应时间在毫秒或微秒级。
-  一般实时系统， 其系统响应时间在几秒的数量级上，其实时性的要求比强实时系统要差一些。 
- ==弱实时系统==， 其系统响应时间约为数十秒或更长。这种系统的响应时间可能 随系统负载的轻重而变化。 

#### 按确定性来分类

- 硬实时:系统对系统响应时间有严格的要求，如果系统响应时间不能满足， 就要引起系统崩溃或致命的错误。
- 软实时:系统对系统响应时间有要求，但是如果系统响应时间不能满足，==不会==导致系统出现==致命==的错误或崩溃。 

#### 按嵌入式系统软件复杂程度来分类

- 循环轮询系统 
- 有限状态机系统
- 前后台系统
- 单处理器多任务系统
- 多处理器多任务系统 


#### 常见应用

- 生活运动
- 智能家庭
- 智慧医疗
- 智能交通
- ……

## 基本组成

### 嵌入式系统的组成

| 组成          |
| ------------- |
| 应⽤软件      |
| 中间件        |
| 运⾏/实时内核 |
| 驱动          |
| 系统硬件      |

硬件以微处理器为核⼼集成存储器和系统专⽤的输⼊/输出设备。

==初始化代码及驱动==、==嵌⼊式操作系统==和==应⽤程序==等，这些软件有机地结合在⼀起，形成==系统特定的⼀体化软件==。

### `IoT/CPS`的基本组成

CPS计算进程和物理进程的统一体，集计算、通信、控制于一体的下一代智能系统，由嵌入式系统、互联网和控制器组成。

 IoT/CPS是由==感知==、==控制==和==决策==3个模块构成的分布式系统。系统模型包括物理层、网络层、协同处理层、应用层。

## 嵌入式系统设计

### 嵌入式系统面临挑战

- 需要多少硬件? 
- 如何满足时限要求,如何处理多项功能在时间上的协调一致关系?
- 如何降低系统的功耗?
- 如何设计以保证系统可升级?
- 如何保证系统可靠地工作?

### 传统开发过程

![image-20211023170550645](https://oss.ydjsir.com.cn/GitPages/EmbeddedBasics/image-20211023170550645.png)

#### 基本特征

- 系统在⼀开始就被划分为软件和硬件两⼤部分；

- 软件和硬件独⽴进⾏开发设计；

- 常常采纳硬件优先方案；

#### 隐含问题
- 软硬件之间的交互受到很⼤限制；
- 凭经验划分软硬件；
- 软硬件之间的相互性能影响很难评估；
- 系统集成相对滞后，NRE（一次性工程费用，`Non-recurring engineering Expense`，`NRE Expense`）较⼤；

### ~~软硬件协同设计~~

对系统设计的影响——协同设计。

- 增加灵活性
- 增加了⻛险

### 软硬件划分

#### 背景

- 软件硬件划分通常由速度、灵活性以及开销来决策
- 嵌⼊式系统的设计涉及硬件与软件部件,设计中必须决定什么功能由硬件实现,什么功能由软件实现。
- 软硬件变动对系统的决策造成影响；
- 划分和选择需要考虑多种因素；
- 硬件和软件的双重性是划分决策的前提；

#### 通常由软件实现部分

- 操作系统功能
- - 任务调度
  - 资源管理
  - 设备驱动
- 协议栈
  - TCP／IP
- 应⽤软件框架

除==基本系统==、==物理接⼝==、==基本逻辑电路==，许多由硬件实现的功能都可以由软件实现。

#### 双重性部分

- 算法
- 特定数学运算（如浮点）

#### 趋势

- 硬软件设计的趋势——融合、渗透（VHDL：硬件设计软件化，ASIC：软件设计硬件化）
- 软硬件协同设计

## 嵌入式硬件系统基础。

### 嵌入式微处理器基础

#### 嵌入式微处理器体系结构

##### 冯诺依曼架构与哈佛架构

前者显然懂的都懂。

**哈佛架构**

- 不支持自修改代码
- 可以至少同时两路并行访问内存（指令和数据分开了）
- 大多数DSP用哈佛架构来处理流式数据，因为这样内存的带宽更大且更可预期

i.       冯诺依曼体系结构数据和程序放在同一个存储单元，统一编址，指令和数据通过同一个总线访问。

ii.      哈佛体系结构的程序和数据不是放在同一个存储空间中，因此有两条总线，也就是说数据吞吐率是冯诺依曼结构的两倍。

![image-20211023172433293](https://oss.ydjsir.com.cn/GitPages/EmbeddedBasics/image-20211023172433293.png)

> 查询资料发现ARM10，ARM11也是哈佛架构

##### CISC与RISC

![image-20211023172230353](https://oss.ydjsir.com.cn/GitPages/EmbeddedBasics/image-20211023172230353.png)

##### 流水线技术

懂的都懂，计组内容。

##### 大端小端

![image-20211025115353823](https://oss.ydjsir.com.cn/GitPages/EmbeddedBasics/image-20211025115353823.png)

##### 选型

###### 按位数分

4位、8位、16位、32位和64位。

###### 按功能分

- 嵌⼊式微处理单元（`MPU`）
- 嵌⼊式微控制器（`MCU`）
- 嵌⼊式`DSP`处理器
- 嵌⼊式`SoC`

#### ~~`ARM`~~

##### ~~工作状态~~

##### ~~运行模式~~

##### ~~寄存器结构~~

##### ~~中断和异常~~

#####  ~~Watchdog~~

看门狗计时器（英语：watchdog timer）是一种电脑硬件式的计时设备，当系统的主程序发生某些错误事件时，如假死机或未定时的清除看门狗计时器的内含计时值（多半是向对计时器发送清除信号，又称喂狗），这时看门狗计时器就会对系统发出重置、重启或关闭的信号，使系统从悬停状态恢复到正常运作状态。

### 嵌入式系统的存储体系

#### 存储器系统：存储器系统的层次结构

![img](file://D:/NJU/2021-Fall/EmbeddedBasics/2020-Introduction-to-Embedded-Systems/img/exam3/8.png?lastModify=1634993699)

#### ROM的种类与选型

1. `ROM`：固定内容、掩膜工艺、无法修改
2. `PROM`：一次编程ROM，一旦导入、无法改变
3. `EPROM`：可擦除ROM
4. `EEPROM`：加电可擦除，多次
5. `FLASH`：闪存存储器

#### Flash的种类与选型

![image-20211023211009647](https://oss.ydjsir.com.cn/GitPages/EmbeddedBasics/image-20211023211009647.png)

#### RAM的种类与选型

1. `SRAM`（`Cache`）：不用刷新，速度快，价格贵，容量小

2. `DRAM`（内存条）：速度稍慢，需要定期加电更新

   `SDRAM`，时钟同步+，`Double Data Rate SDRAM`（`DDR`，懂的都懂）

#### ~~Cache~~

### 嵌入式系统总线

#### 总线结构，常见的总线及特点

总线让CPU、内存和设备间能相互通信。结构主要有单、双、多三种。

地址线、数据线和控制线，前面两个可以复用。

![image-20211023220937234](https://oss.ydjsir.com.cn/GitPages/EmbeddedBasics/image-20211023220937234.png)

| 类型       | 说明                                                         | 图示                      |
| ---------- | ------------------------------------------------------------ | ------------------------- |
| 单总线结构 | 使用一条==单一==的系统总线来链接CPU、主存和I/O设备。总线只能分时工作，使信息传送的吞吐量受到限制 | ![](https://oss.ydjsir.com.cn/GitPages/EmbeddedBasics/10.png) |
| 双总线结构 | 在CPU和主存之间专门设置了一组高速的存储总线，使CPU可通过专用总线与存储器交换信息，并减轻了系统总线的负担。中间用==桥==连接。主存仍可通过系统总线与外设之间实现==DMA==操作，而不必经过CPU。 | ![](https://oss.ydjsir.com.cn/GitPages/EmbeddedBasics/11.png) |
| 多总线结构 | 在双总线系统的基础上增加==I/O总线==，其中系统总线是CPU、主存和通道(IOP)之间进行数据传送的公共通路，而I/O是多个外部设备与通道之间进行数据传送的公共通路。通道实际上是一台具有特殊功能的处理器，它分担了一部分CPU的功能，以实现对外设的统一管理及外设与主存之间的数据传送。（比如说==南北桥==） | ![](https://oss.ydjsir.com.cn/GitPages/EmbeddedBasics/12.png) |

#### 输入输出编程：忙等IO和中断IO

忙等效率比较低，CPU在等待设备的时候不能做其他工作，无法同步进行输入输出。

中断IO允许设备更改CPU控制流，提高CPU利用率。

#### Programming I/O：Independent I/O port. memory-mapped I/O.

X86使用前者，其他架构大多选择后者。注意到支持前者并不意味着不支持后者。

##### 内存映射IO的优缺点

###### 优点

- 开发简单，控制寄存器直接对应内存，可以纯C开发，可以复用内存保护机制来保护IO设备

###### 缺点

- 这些内存地址不能被cache，硬件需要单独设计。
- 同一地址空间下内存引用和IO都需要访问同一内存地址空间，影响系统效率。

##### 第三条道路：混合解决方案

内存映射I/O 数据缓存和为控制寄存器所对应的的独立 I/O端口。

#### ~~GPIO接口基本原理与结构（不考）~~

## 嵌入式系统软件知识

### 嵌入式软件基础知识

#### 嵌入式软件的特点

- 内存有限
- 性能弱
- 追求确定性
- 平台多样，与硬件结合紧密
- 与成本等商业模式要素密切相关

#### 嵌入式软件的分类

##### 系统软件

##### 支撑软件

##### 应用软件

#### 嵌入式软件体系结构

##### 驱动层

- 板级初始化程序
- 与系统软件相关的驱动
- 与应用软件相关的驱动 
- 与应用软件相关的驱动不一定需要与操作系统连接，这些驱动的设计和开发由应用决定。

##### 操作系统层

- 操作系统层包括嵌入式内核、嵌入式TCP/IP网络系统、嵌入式文件系统、嵌入式GUI系统和电源管理等部分。
- 其中==嵌入式内核==是基础和必备的部分，其他部分要根据嵌入式系统的需要来确定。

##### 中间件层

- 目前在一些复杂的嵌入式系统中也开始采用中间件技术，

##### 应用层 

- 应用层软件主要由多个相对独立的应用任务组成
- 每个应用任务完成特定的工作，如I/O任务、计算的任务、通信任务等，由操作系统调度各个任务的运行。

### 嵌入式操作系统基础知识

#### RTOS概念、特点、选型原则（商业化RTOS）

##### 定义

对外来事件能在限定的响应时间内做出预定质量处理的计算机系统。

##### 特点

可移植性、强调实时性能、内核精简、抢占式内核、使用可重入函数、可配置、可裁剪、高可靠性。

举例：`μC/OS-II`，`ThreadX`，`VxWorks`，`Linux/RT`，`FreeRTOS`

选型原则：==综合权衡==

1. 成本
2. 可靠性
3. 实时性
4. 工具链
5. 模块丰富
6. RTOS系统资源占用量（RAM、ROM）
7. 支持

> **可重入函数**主要用于多任务环境中，一个**可重入**的**函数**简单来说就是**可以**被中断的**函数**，也就是说，**可以**在这个**函数**执行的任何时刻中断它，转**入**OS调度下去执行另外一段代码，而返回控制时不会出现什么错误。
>
> 但是有些函数使用了一些特定的资源，如中断向量表和全局变量等，如果它们被中断了，恢复时可能出现难以预料的结果。操作系统中，这些不能被中断的过程叫原语

#### 任务管理

##### 进程、线程、任务的概念

这是OS课的内容

##### 任务的实现

（任务的层次结构、任务控制块、任务的状态及状态转换、任务队列）

##### 任务调度

（可抢占调度、不可抢占调度、先来先服务、时间片轮转算法、优先级算法）

##### 实时系统及任务调度

> WRT Stands for: **With Respect To**

###### RMS-抢占式-静态优先级

==看实验部分==

（周期性任务）最短周期优先，

优势：实现简单

###### EDF-抢占式-动态优先级

==看实验部分==

（周期性任务）最近截止时间优先，参看实验

优势：最低延迟，公平性更高，RMS不能100%利用率但EDF可以，EDF抢占次数更少，截止时间可以不是周期。

缺点：当该系统超载、会错过最后期限的进程集合很大程度上是不可预知的。在实时操作系统上，这是一个相当大的缺点。 算法也难以使用硬件硬件)实现，表达不同范围内的截止时间也是一个棘手的问题。

##### 任务间通信

###### 共享内存

需要信号灯

###### 消息

**消息邮箱**

⼀个任务或ISR可以通过邮箱向另⼀个任务发送⼀个指针型的变量，该指针指向⼀个包
含了特定“消息”（message）的数据结构。

**消息队列**

⼀个消息队列可以容纳多个不同的消息，因此可把它看作是由多个邮箱组成的数组，只是它们共⽤⼀个等待任务列表。

###### 管道

类似Linux里的管道

###### 信号量

##### 同步与互斥

###### 竞争条件

###### 临界区

**临界区段**（Critical section）或称为**关键区块** ，指的是一个访问共享资源（例如：共享设备或是共享存储器）的程序片段，而这些共享资源又无法同时被多个[线程](https://zh.wikipedia.org/wiki/執行緒)访问的特性。

###### 互斥

μC/OS采⽤关闭/打开中断的⽅式来处理临界区代码，从⽽避免竞争条件，实现任务间的互斥；μC/OS定义两个宏(macros)来开关中断，即：`OS_ENTER_CRITICAL()`和`OS_EXIT_CRITICAL()`。这两个宏的定义取决于所⽤的微处理器，每种微处理器都有⾃⼰的`OS_CPU.H`⽂件。

###### 信号量

**信号量**（英语：**semaphore**）又称为**信号标**、信号灯，是一个同步对象，用于保持在0至指定最大值之间的一个计数值。当线程完成一次对该对象的等待（`wait`）时，该计数值减`1`；当线程完成一次对对象的释放（`release`）时，计数值加`1`。当计数值为0，则线程等待该对象不再能成功直至该对象变成`signaled`状态。对象的计数值大于0，为`signaled`状态；计数值等于`0`，为`nonsignaled`状态。

###### 死锁

#### 存储管理

嵌入式系统静态和动态内存管理

#### ~~设备管理（不考）~~

设备无关性、I/O地址、I/O控制、中断处理

#### ~~文件系统基础知识（不考）~~

#### ~~操作系统移植基础知识（不考）~~

###  ~~嵌入式系统程序设计（不考）~~

#### ~~嵌入式软件开发基础知识~~

#### ~~嵌入式程序设计语言~~

##### ~~汇编、编译、解释系统的基础知识和基本工作原理~~

##### ~~汇编语言~~

##### ~~各类程序设计语言的主要特点和适用情况~~

#### ~~嵌入式软件开发环境~~

##### ~~交叉开发（宿主机、目标机）~~

##### ~~编辑器、编译器、链接器、调试器、模拟器~~

##### ~~常用嵌入式开发工具~~

##### ~~集成开发环境~~

##### ~~开发辅助工具~~

#### ~~嵌入式软件开发~~

## 嵌入式实时内核（结合`μcOS-II`~~和`FreeRTOS`~~）

### 实时任务调度

==看实验部分==

如果进程组不可调度，⼜需要保证在截⾄时限前完成

- 使⽤更快的`CPU`。不改变周期就可以减少执⾏时间。
  但`CPU`利⽤率更低。
- 重新设计进程以减少执⾏时间。需要了解代码。
- 重写规格说明以改变截⾄时限。（？？？）

> 无比正确的废话

### 中断与时钟

μC/OS_II进行任务调度的思想是 “近似地每时每刻==总是让优先级最高的就绪任务处于运行状态==” 。为了保证这一点，它在系统或用户任务调用系统函数及执行中断服务程序结束时总是==调用调度器==，来确定应该运行的任务并运行它 。

μC/OS_II进行任务调度的依据就是任务就绪表，能以常数级的时间复杂度实现调度。

#### 如何让`μcOS-II`支持更多的任务调度（255个）？

1. 修改`os_cfg.h`中`#define OS_LOWEST_PRIO 63 -> 254`
2. 新版的`μcOS-II`可以自动根据`OS_LOWEST_PRIO`的大小判断TBL大小和算法，不需要修改，对于旧版，则`ucos_ii.h`中修改TCB表的大小(8->16)，在`os_core.c`中个修改算法。
   1. 将16位修改成低8位和高8位：若低8位为0，则在高8位，反之则为低8位，找到高低之和，再进行进一步判断
   2. 总之将8组 * 8个/组->16组 * 16个每组，高八位计算按位运算模式使用Map，并在最后计算优先级时+8再算。

#### 优先级翻转问题

当一个高优先级任务通过信号量机制访问共享资源时，该信号量已低优先级任务占有，高优先级任务被阻塞，无法保证实时性。这是一个问题。倘若有一进程的优先级介乎两者之间，它抢了低优先级的CPU时间却不释放其资源，导致高优先级进程也要一同等待。于是乎，中优先级的进程执行中体现的优先级却比高优先级的进程高。

> 有优先级为A、B和C三个任务，优先级A>B>C，任务A，B处于[挂起状态](https://baike.baidu.com/item/挂起状态)，等待某一事件发生，任务C正在运行，此时任务C开始[使用](https://baike.baidu.com/item/使用)某一共享资源S。在使用中，任务A等待事件到来，任务A转为就绪态，因为它比任务C优先级高，所以立即执行。当任务A要使用共享资源S时，由于其正在被任务C使用，因此任务A被挂起，任务C开始运行。如果此时任务B等待事件到来，则任务B转为就绪态。由于任务B优先级比任务C高，因此任务B开始运行，直到其运行完毕，任务C才开始运行。直到任务C释放共享资源S后，任务A才得以执行。在这种情况下，优先级发生了翻转，任务B先于任务A运行。
>
> 火星车实例

##### 优先级天花板（立即优先级上限，ICPP）

==当任务申请资源时==，把该任务的优先级提升到可访问这个资源的所有任务的最高优先级。此优先级称为这个资源的优先级天花板，此方案==简单可行==，不管任务是否阻塞了高优先级任务运行，只要任务访问共享资源则提升优先级。

##### 优先级集成（原始优先级上限，OCPP）

==当任务A申请共享资源S==，如果S正在被任务C使用，通过比较任务C和自身优先级，如果C < A，则任务C的优先级提高到自身A的优先级，C释放资源S后，恢复到原始优先级，此方法==只在低优先级阻塞高优先时才动态改变优先级==，过程复杂时需要多次判断。

### 同步与通信

 管理的核心是事件控制块ECB，同步可以通过开关中断实现。互斥使用信号量。

通信可以使用**邮箱**和**消息队列**实现。

### 存储管理（静态、动态）

 操作系统课内容在此不再赘述。

`μcOS-II`不划分内核和用户空间，系统只有一个地址空间。

管理：==多个内存分区，每个分区的块大小相同，不同分区的块大小不同==，为了解决碎片问题。

## `BSP`， `bootloader`

### 嵌入式系统的启动过程

![image-20211023234005620](https://oss.ydjsir.com.cn/GitPages/EmbeddedBasics/image-20211023234005620.png)

### `BSP`，特点，与`BIOS`区别

BSP的概念：BSP 全称“板级支持包”(Board Support Packages),说的简单一点,就是一段启动代码, 和计算机主板的 BIOS 差不多,但提供的功能区别就相差很大。

#### 特点与功能

硬件相连性：BSP必须为操作系统提供操作和控制具体硬件的方法；

操作系统相连性：BSP必须为不同的操作系统提供接口；

#### BIOS和BSP区别

BIOS主要是负责在电脑开启时检测、初始化系统设备（设置栈指针，中断分配，内存初始化..）、装入操作系统并调度操作系统向硬件发出的指令。

==BIOS程序是用户不能更改==，编译编程的，只能对参数进行修改设置。更不会包含一些基本的硬件驱动。

BSP是和操作系统绑在一起运行在主板上的，尽管BSP的开始部分和BIOS所做的工作类似，可是大部分和BIOS不同，作用也完全不同。

程序员还可以编程修改BSP，在BSP中任意添加一些和系统无关的驱动或程序，甚至可以==把上层开发的统统放到BSP中==。 

> 由于EFI框架比BIOS要大得多，其启动过程也比BIOS要复杂。于BIOS最大的区别就是EFI首先需要EBC虚拟机，然后再启动设备驱动和EFI应用程序，最后通过EFI boot manager加载操作系统引导程序。

### 引导模式

操作系统引导概念：将操作系统装入内存并开始执行的过程。

按时间效率和空间效率不同的要求，分为两种模式：

1. 需要`BootLoader`的引导模式：节省空间，牺牲时间，适用于硬件成本低，运行速度快，但启动速度相对慢。

2. 不需要`BootLoader`的引导模式：时间效率高，系统快速启动，直接在NOR flash或ROM系列非易失性存储介质中运行，但不满足运行速度的要求。

### `bootloader`及其启动过程

`BootLoader`的概念：`BootLoader`是嵌入式系统中的OS启动加载程序。

#### 启动过程

●     初始化硬件，如设置UART（至少设置一个），检测存储器等

●     设置启动参数，告诉内核硬件的信息，如用哪个启动界面，波特率

●     跳转到操作系统的首地址

●     消亡

## 建模

> 建模→设计→分析
>
> **state-oriented model**
>
> - Finite State Machines
>
> **activity-oriented model**
>
> - Data-Flow/Process Models，把系统描绘成⼀组与数据或者执⾏的相关性有
>   关的活动的集合；
>
> **structure-oriented model**
>
> - 框图
> - 着重强调系统的物理构成
>
> **data-oriented model**
>
> - 实体-关系图
>
> **heterogeneous-oriented model**
>
> - 综合前四种模型特征
> - 表达复杂系统的多种不同视图

### 有限状态机及其应用

> 看作业

#### 两种有限状态机

- `Moore`：输出仅与当前状态有关
- `Mealy`：输出不仅仅与当前状态有关，也与输入有关
- `Moore`与`Mealy`结合的有限状态机

### 有限状态机的实现。

> 看作业

```bash
FSM = (
	{Input symbols},
	{Output Symbols},
	{States},
	{Initial States},
	Transition Relation (mapping of Input Symbol, Current State to next State(s)
	Output Function (mapping of Input Symbol, Current State to Current Output Symbol)
)
```

![image-20211025103558532](https://oss.ydjsir.com.cn/GitPages/EmbeddedBasics/image-20211025103558532.png)

有限状态机的等价：不要求同构

`FSM`，`DFA`和`NFA` (`Nondeterministic Finite Automaton`) 是等价的。但是后者往往更简洁。

**状态器**是[有限状态自动机](https://zh.wikipedia.org/wiki/有限状态自动机)的图形表示。另一种可能的表示是[状态转移表](https://zh.wikipedia.org/wiki/状态转移表)。状态图有很多形式，它们有稍微的差异并有不同的语义。

> 关键还是在设计题？

## 考试形式：闭卷、笔试

### 范围

基本概念、基本原理、设计应用技术。

以课件涵盖内容为主，重点在于授课时强调的内容==！！！==

### 题型

1. 简答题（50分）

2. 问答题（30分）

3. 设计题（20分）